
- [Домашнее задание к занятию «Микросервисы: принципы»](#домашнее-задание-к-занятию-микросервисы-принципы)
  - [Задача 1: API Gateway](#задача-1-api-gateway)
  - [Ответ](#ответ)
    - [Примеры API-gateway](#примеры-api-gateway)
    - [Kong](#kong)
  - [Задача 2: Брокер сообщений](#задача-2-брокер-сообщений)
    - [Основная информация о RabbitMq](#основная-информация-о-rabbitmq)
    - [Основные понятия](#основные-понятия)
      - [Exchange](#exchange)
        - [Типы exchange](#типы-exchange)

# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 


## Ответ
### Примеры API-gateway

| #   | Наименование                                                                 | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| --- | ---------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1   | [Azure API Management](https://azure.microsoft.com/services/api-management/) | Служба управления API Azure не только позволяет удовлетворить потребности шлюза API, но и предоставляет дополнительные функции, например сбор аналитических данных от интерфейсов API. Если вы используете решение для управления API, шлюз API является только компонентом в рамках полного решения по управлению API.                                                                                                                                                                                                                                      |
| 2   | [Ocelot](https://github.com/ThreeMammals/Ocelot)                             | Это упрощенный шлюз API, рекомендуемый для более простых случаев. Шлюз API Ocelot с открытым кодом на основе .NET Core специально разработан для архитектуры микрослужб, в которой нужны единые точки входа в систему. Он не требует большого количества ресурсов, быстро работает, легко масштабируется, а также наряду с многими другими функциями поддерживает маршрутизацию и проверку подлинности.                                                                                                                                                      |
| 3   | [Kong Gateway](https://konghq.com/products/kong-gateway)                     | Kong Gateway — это open source, cloud-native решение, написанное на Lua. По сути, это надстройка над Nginx. Kong Gateway поддерживает DB-less декларативную конфигурацию, используя только in-memory хранилище и собственные Kubernative CRD. Одно из самых популярных open source решений. Есть богатая библиотека плагинов Plugin Hub, содержащая более 90 плагинов, за счет чего и имеется самое большое количество интеграций с различными внешними сервисами. Есть возможность писать кастомные плагины на Go и Lua. Есть поддержка GraphQL из коробки. |
                                                                                                                                                                                                                                                                                    
Также множество различных API-gateway решений описаны на [странице]([16 лучших API-шлюзов для современных приложений - Notissimus.com](https://notissimus.com/16-luchshih-api-shlyuzov-dlya-sovremennyh-prilozhenij/#Apache_APISIX))

### Kong

| #   | Требование                                                      | Выбранное решение                                                                                      |
| --- | --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| 1   | Маршрутизация запросов к нужному сервису на основе конфигурации | Настроить в конге правила маршрутизации                                                                |
| 2   | Возможность проверки аутентификационной информации в запросах   | Использование плагина kong-auth-plugin                                                                 |
| 3   | Обеспечение терминации HTTPS                                    | Настроить на балансировщике нагрузки                                                                   |
| 4   | Удобство настройки в конфиге                                    | Реализация отдельного сервиса-конфига, в котором при пуше изменений в каждый сервис проставлять версию |

## Задача 2: Брокер сообщений

Для большинства целей подходит  RabbitMq. Легко разворачивается. К примеру в докере.
Маппинг Exchange, Queues настраивается в конфиг сервисе в yaml файле.

Kafka обладает более расширенными возможностями, но более сложная в эксплуатации.

### Основная информация о RabbitMq

### Основные понятия

| #   | Термин   | Описание                                                                                                                          |
| --- | -------- | --------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Durable  | Устойчивый к перезагрузке                                                                                                         |
| 2   | Internal | Если проставлено yes, то клиенты не могут публиковать напрямую сообщения. Можем только использовать биндинги exchange на exchange |

#### Exchange

##### Типы exchange

| #   | Тип         | Описание                                                                                                                                                                                                                                                                                                                                  |
| --- | ----------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Direct      | Точное совпадение routing_key                                                                                                                                                                                                                                                                                                             |
| 2   | Topic       | Указание routing_key с помощью паттерна. Пример: event*                                                                                                                                                                                                                                                                                   |
| 3   | Fanout      | Отправляем всем, кто bind, независимо от того, что они хотят. Пример: если отправили в 2 очереди с разными routing_key (binding). Несмотря на то, что routing_key не совпадает, сообщение будет доставлено в обе очереди. Используется для массовой рассылки уведомлений всем подписчикам. fanout не ограничивает с точки зрения binding. |
| 4   | Headers     | Отправляет всем сообщение независимо от routing_key. Смотрит исключительно на заголовки. Header - справочник. Отправляет только в те очереди, в которых в headers параметрах указаны нужные.                                                                                                                                              |
| 5   | Default     | Позволяет публиковать напрямую очередь. Вместо routing_key указывается наименование очереди                                                                                                                                                                                                                                               |
| 6   | Dead Letter | Очередь, которая собирает "Мертвые" сообщения                                                                                                                                                                                                                                                                                             |


