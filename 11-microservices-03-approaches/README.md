# Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

## Решение

| №   | Требование                                                                | Решение                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Обоснование                                                                                                        |
| --- | ------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| 1   | Облачная система                                                          | YandexCloud                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Удобство развертывания<br/>Удобный интерфейса<br/>Наличие CLI<br/>Наличие службы порддержки для решения инцидентов |
| 2   | Система контроля версий Git                                               | GitLab                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Удобство развертывания<br/>Богатый функционал из "коробки""                                                        |
| 3   | Репозиторий на каждый сервис                                              | Разместить код каждого сервиса в отдельном репозитории. Наименование репозитория начать с префикса "svc-"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | -                                                                                                                  |
| 4   | Запуск сборки по событию из системы контроля версий                       | Реализовать следующий порядок внесения изменений в код сервисов:<br/>1. git pull<br/>2. git checkout -b feature/<task number>-<short description><br/>3. Add changes<br/>4. git add *<br/>5. git commit -m "Short description"<br/>6. git push -u origin feature/<task number>-<short description><br/>Результат: в gitlab автоматически создается PR и запускается пайплайн для сборки артефакта проекта, а также автоматизированные тесты<br/>По итогам успешной сборки и прохождения автотестов требуется code review. После получения approve происходит merge изменений в ветку master. | -                                                                                                                  |
| 5   | Запуск сборки по кнопке с указанием параметров                            | Реализовать в gitlab возможность запуска пайплайна после выбора окружения, на котором необходимо разместить изменения                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | -                                                                                                                  |
| 6   | Возможность привязать настройки к каждой сборке                           | Реализовать в проекте репозиторий-конфиг, в котором в файле settings.json после успешного merge сервиса в мастер ветку разработчику нужно указать последнюю версию сборки сервиса                                                                                                                                                                                                                                                                                                                                                                                                            | -                                                                                                                  |
| 7   | Возможность создания шаблонов для различных конфигураций сборок           | Сформировать описание шаблона в виде yaml файла в отдельном репозитории с наименованием <project name>-init                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | -                                                                                                                  |
| 8   | Возможность безопасного хранения секретных данных (пароли, ключи доступа) | Использовать шифрование с помощью vault в кластере kubernetes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | -                                                                                                                  |
| 9   | Несколько конфигураций для сборки из одного репозитория                   | Сформировать описание конфигураций сборки в репозитории-конфиге                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | -                                                                                                                  |
| 10  | Кастомные шаги при сборке                                                 | В описании параметров сборки сервиса в yaml файле добавить отдельные шаги, которые запускают к примеру запуск проверки кода статическим анализатором, к примеру SonarQube                                                                                                                                                                                                                                                                                                                                                                                                                    | -                                                                                                                  |
| 11  | Собственные докер-образы для сборки проектов                              | Для каждого сервиса реализовать механизм формирование обновленного докер-образа при сборке сервиса                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | -                                                                                                                  |
| 12  | Возможность развернуть агентов сборки на собственных серверах             | В пункте 1 выбран провайдер YandexCloud. Если организация может себе позволить оплачивать данный сервис, то удобнее использовать его                                                                                                                                                                                                                                                                                                                                                                                                                                                         | -                                                                                                                  |
| 13  | Возможность параллельного запуска нескольких сборок                       | Запуск сборки и прохождения автотестов каждого сервиса не должен блокировать сборку и автотесты другого сервиса. <br/>Важно реализовать мониторинг использования ресурсов виртуальных машин для избежания неожиданных падений сборок сервисов                                                                                                                                                                                                                                                                                                                                                | -                                                                                                                  |
| 14  | Возможность параллельного запуска тестов                                  | См. пункт 13 данной таблицы                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | -                                                                                                                  |

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

## Решение

| №   | Требование                                                                                                               | Решение                                                                                                                                          | Обоснование                                                                                                                                                                        |
| --- | ------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Сбор логов в центральное хранилище со всех хостов, обслуживающих систему                                                 | При создании namespace разворачивать экземпляр ElasticStack. К примеру Opensearch + logstash + fluentbeat.                                       | Доступ к логам на каждом namespace окружении позволит производить детальное тестирование и поиск логов сервисов при различных ошибках или получать подтверждение различных гипотез |
| 2   | Минимальные требования к приложениям, сбор логов из stdout                                                               | В коде каждого сервиса при вызове метода вызывать метод записи логов с кастомным выводом, которые описывает шаг процесса, который вызывает метод | -                                                                                                                                                                                  |
| 3   | Гарантированная доставка логов до центрального хранилища                                                                 | Реализовать мониторинг логов на предмет превышения размеров хранилища                                                                            | -                                                                                                                                                                                  |
| 4   | Обеспечение поиска и фильтрации по записям логов                                                                         | Поиск в логах может производиться только по полям, которые были предварительно добавлены в список индексируемых                                  | -                                                                                                                                                                                  |
| 5   | Обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов | Использовать  OpenSearch или Kibana для визуализации данных                                                                                      | Удобство поиска информации в логах                                                                                                                                                 |
| 6   | Возможность дать ссылку на сохранённый поиск по записям логов                                                            | OpenSearch или Kibana позволяют сохранять и делиться запросами и результатами поиска логов                                                       | -                                                                                                                                                                                  |

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

## Решение

| №   | Требование                                                                                                | Решение                                                                                                                                        | Обоснование                       |
| --- | --------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| 1   | Сбор метрик со всех хостов, обслуживающих систему                                                         | Использование Graphana                                                                                                                         | Удобство развертывания, настройки |
| 2   | Сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network                                             | Настроить в Graphana сбор указанных метрик                                                                                                     | -                                 |
| 3   | Сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network                             | Настроить в Graphana сбор указанных метрик                                                                                                     | -                                 |
| 4   | Сбор метрик, специфичных для каждого сервиса                                                              | Настроить в Graphana сбор указанных метрик                                                                                                     | -                                 |
| 5   | Пользовательский интерфейс с возможностью делать запросы и агрегировать информацию                        | Функционал Graphana позволяет выполнять запросы и агрегировать информацию                                                                      | -                                 |
| 6   | Пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы | Функционал Graphana позволяет настраивать различный dashboards для визуализаии и быстрого доступа к просмотру нужных метрик по каждому сервису | -                                 |